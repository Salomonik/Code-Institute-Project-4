{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{% block title %}My Shop{% endblock %}</title>
	<link rel="stylesheet" href="{% static 'css/style.css' %}" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
	<link rel="icon" href="{% static 'images/favicon.ico' %}" />
</head>

<body>
	{% if messages %}
	<div class="messages">
		{% for message in messages %}
		<div class="alert alert-{{ message.tags }}">
			{{ message }}
		</div>
		{% endfor %}
	</div>
	{% endif %}
	<header>
		<!-- Navbar -->
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container">
				<!-- Logo -->
				<a class="navbar-brand" href="{% url 'home' %}">
					<img src="{% static 'images/logo.webp' %}" alt="Logo" width="120">
				</a>

				<!-- Toggle button for mobile view -->
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
					aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>

				<!-- Navbar links -->
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link" href="{% url 'home' %}">Home</a>
						</li>

						<!-- Dropdown for categories -->
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="categoriesDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Categories
							</a>
							<div class="dropdown-menu" aria-labelledby="categoriesDropdown">
								{% for category in categories %}
								<a class="dropdown-item" href="{% url 'products:category_products' category.slug %}">
									{{ category.name }}
								</a>
								{% endfor %}
							</div>
						</li>

						<!-- Static links -->
						<li class="nav-item">
							<a class="nav-link" href="{% url 'about' %}">About Us</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="{% url 'contact' %}">Contact</a>
						</li>

						<!-- Login/Register link -->
						{% if not user.is_authenticated %}
						<li class="nav-item">
							<a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
								aria-controls="offcanvasRight">Login/Register</a>
						</li>
						{% else %}
						<li class="nav-item">
							<form method="POST" action="{% url 'accounts:logout' %}">
								{% csrf_token %}
								<button type="submit" class="btn btn-link nav-link"
									style="border: none; background: none;">
									Logout
								</button>
							</form>
						</li>
						{% endif %}
						<li>
							<button id="cart-button">
								<i class="fas fa-shopping-cart"></i> Cart
								<span id="cart-total-items">0</span>
							</button>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Offcanvas for Login/Register -->
		<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
			<div class="offcanvas-header">
				<h5 id="offcanvasRightLabel">REGISTER</h5>
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<!-- Registration Form (initially shown) -->
				<div id="register-form">
					<form method="POST" action="{% url 'accounts:register' %}">
						{% csrf_token %}
						<div class="mb-3">
							<label for="username" class="form-label">Username</label>
							<input type="text" class="form-control" id="username" name="username" required>
						</div>
						<div class="mb-3">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="password" class="form-label">Password</label>
							<input type="password" class="form-control" id="password" name="password" required>
						</div>
						<button type="submit" class="btn btn-primary">Register</button>
					</form>
					<div class="mt-3">
						<a href="#" id="show-login">Already have an account? Login here</a>
					</div>
				</div>

				<!-- Login Form (hidden initially) -->
				<div id="login-form" style="display: none;">
					<form method="POST" action="{% url 'accounts:login' %}">
						{% csrf_token %}
						<div class="mb-3">
							<label for="login-email" class="form-label">Email *</label>
							<input type="email" class="form-control" id="login-email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="login-password" class="form-label">Password *</label>
							<input type="password" class="form-control" id="login-password" name="password" required>
						</div>
						<div class="mb-3">
							<a href="{% url 'accounts:password_reset' %}">Forgot your password?</a>
						</div>
						<button type="submit" class="btn btn-primary">Sign In</button>
					</form>
					<div class="mt-3">
						<a href="#" id="show-register">New customer? Create your account</a>
					</div>
				</div>
			</div>
		</div>


		<!-- Off-Canvas Cart Container -->
		<div id="cart-off-canvas" class="off-canvas">
			<div class="cart-header">
				<h2>Shopping Cart</h2>
				<button id="close-cart" class="close-btn">&times;</button>
			</div>
			<div id="cart-items-container">
				<!-- Cart items will be dynamically loaded here -->
			</div>
			<div class="cart-footer">
				<p id="cart-subtotal">Subtotal: $0</p>
				<button id="checkout-btn" class="btn">Checkout</button>
			</div>
		</div>

		<!-- Overlay -->
		<div id="cart-overlay" class="overlay"></div>


		<!-- Toast Container -->
		<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
			<div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
				<div class="toast-header">
					<strong class="me-auto">Success</strong>
					<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
				</div>
				<div class="toast-body">
					Account created successfully!
				</div>
			</div>
		</div>
	</header>

	<main class="container mt-4">
		{% block content %}
		{% endblock %}
	</main>

	<footer class="footer mt-auto py-3 bg-light">
		<div class="container">
			<span class="text-muted">© 2024 My Shop. All rights reserved.</span>
		</div>
	</footer>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

	<!-- JavaScript to handle forms -->
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const showRegisterLink = document.getElementById('show-register');
			const showLoginLink = document.getElementById('show-login');
			const loginForm = document.getElementById('login-form');
			const registerForm = document.getElementById('register-form');
			const offcanvasElement = document.getElementById('offcanvasRight');
			const offcanvas = new bootstrap.Offcanvas(offcanvasElement);

			// Toggle between login and register forms
			showRegisterLink?.addEventListener('click', function (e) {
				e.preventDefault();
				loginForm.style.display = 'none';
				registerForm.style.display = 'block';
			});

			showLoginLink?.addEventListener('click', function (e) {
				e.preventDefault();
				loginForm.style.display = 'block';
				registerForm.style.display = 'none';
			});

			// Function to handle form submissions
			function handleFormSubmit(form, url) {
				if (!form) return;

				form.addEventListener('submit', async function (event) {
					event.preventDefault();
					console.log('Form submitted to URL:', url); // Debug log

					// Clear previous errors
					form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
					form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
					const alertDiv = form.querySelector('.alert');
					if (alertDiv) alertDiv.remove();

					const submitButton = form.querySelector('button[type="submit"]');
					submitButton.disabled = true;

					try {
						const formData = new FormData(form);
						// Log form data for debugging
						for (let pair of formData.entries()) {
							console.log(pair[0] + ': ' + pair[1]);
						}

						const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
						console.log('CSRF Token present:', !!csrfToken); // Debug log

						if (!csrfToken) {
							throw new Error('CSRF token not found');
						}

						const response = await fetch(url, {
							method: 'POST',
							headers: {
								'X-CSRFToken': csrfToken,
								'X-Requested-With': 'XMLHttpRequest',
							},
							body: formData
						});

						console.log('Response status:', response.status); // Debug log
						// Log raw response for debugging
						const responseText = await response.text();
						console.log('Raw response:', responseText);

						let data;
						try {
							data = JSON.parse(responseText);
						} catch (e) {
							console.error('JSON parse error:', e);
							throw new Error('Invalid JSON response from server');
						}

						if (response.ok && data.success) {
							const successToast = new bootstrap.Toast(document.getElementById('successToast'));
							document.querySelector('#successToast .toast-body').textContent =
								data.message || 'Logged in successfully!';
							successToast.show();

							offcanvas.hide();

							setTimeout(() => {
								window.location.href = data.redirect_url || '/';
							}, 1000);
						} else {
							submitButton.disabled = false;

							if (data.errors) {
								Object.entries(data.errors).forEach(([field, errors]) => {
									const inputElement = form.querySelector(`[name="${field}"]`);
									if (inputElement) {
										inputElement.classList.add('is-invalid');
										const errorElement = document.createElement('div');
										errorElement.className = 'invalid-feedback';
										errorElement.textContent = Array.isArray(errors) ? errors[0] : errors;
										inputElement.parentNode.appendChild(errorElement);
									}
								});
							}

							// Pokaż ogólny komunikat błędu jeśli jest
							if (data.message) {
								const errorDiv = document.createElement('div');
								errorDiv.className = 'alert alert-danger mt-3';
								errorDiv.textContent = data.message;
								form.insertBefore(errorDiv, form.firstChild);
							}
						}
					} catch (error) {
						console.error('Detailed error:', error); // Detailed error logging
						submitButton.disabled = false;

						const errorDiv = document.createElement('div');
						errorDiv.className = 'alert alert-danger mt-3';
						errorDiv.textContent = 'An error occurred: ' + error.message;
						form.insertBefore(errorDiv, form.firstChild);
					}
				});
			}

			// Initialize form handlers
			const loginFormElement = document.querySelector('#login-form form');
			const registerFormElement = document.querySelector('#register-form form');

			if (loginFormElement) {
				console.log('Login form found, action URL:', loginFormElement.action); // Debug log
				handleFormSubmit(loginFormElement, loginFormElement.action);
			}
			if (registerFormElement) {
				console.log('Register form found, action URL:', registerFormElement.action); // Debug log
				handleFormSubmit(registerFormElement, registerFormElement.action);
			}
		});

		document.addEventListener("DOMContentLoaded", function () {
			const cartButton = document.getElementById('cart-button'); // Your cart icon/button
			const cartOffCanvas = document.getElementById('cart-off-canvas');
			const cartOverlay = document.getElementById('cart-overlay');
			const closeCartButton = document.getElementById('close-cart');

			cartButton.addEventListener('click', function () {
				cartOffCanvas.classList.add('show');
				cartOverlay.classList.add('show');
			});

			closeCartButton.addEventListener('click', function () {
				cartOffCanvas.classList.remove('show');
				cartOverlay.classList.remove('show');
			});

			cartOverlay.addEventListener('click', function () {
				cartOffCanvas.classList.remove('show');
				cartOverlay.classList.remove('show');
			});
		});

		document.querySelectorAll('.add-to-cart').forEach(function (button) {
			button.addEventListener('click', function (e) {
				e.preventDefault();
				const productId = this.dataset.productId;  // Get product ID

				fetch(`/cart/add/${productId}/`, {
					method: 'POST',
					headers: {
						'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({})
				})
					.then(response => response.json())
					.then(data => {
						document.getElementById('cart-subtotal').textContent = `Subtotal: $${data.cart_total_price}`;
						// Handle other updates like updating cart items
					});
			});
		});


	</script>
	<script src="https://kit.fontawesome.com/ba182bdcb1.js" crossorigin="anonymous"></script>
</body>

</html>