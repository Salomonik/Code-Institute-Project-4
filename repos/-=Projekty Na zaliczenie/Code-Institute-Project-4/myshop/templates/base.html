{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{% block title %}My Shop{% endblock %}</title>
	<link rel="stylesheet" href="{% static 'css/style.css' %}" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
	<link rel="icon" href="{% static 'images/favicon.ico' %}" />
</head>

<body>
	{% if messages %}
	<div class="messages">
		{% for message in messages %}
		<div class="alert alert-{{ message.tags }}">
			{{ message }}
		</div>
		{% endfor %}
	</div>
	{% endif %}
	<header>
		<!-- Navbar -->
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container">
				<!-- Logo -->
				<a class="navbar-brand" href="{% url 'home' %}">
					<img src="{% static 'images/logo.webp' %}" alt="Logo" width="120">
				</a>

				<!-- Toggle button for mobile view -->
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
					aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>

				<!-- Navbar links -->
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link" href="{% url 'home' %}">Home</a>
						</li>

						<!-- Dropdown for categories -->
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="categoriesDropdown" role="button"
								data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Categories
							</a>
							<div class="dropdown-menu" aria-labelledby="categoriesDropdown">
								{% for category in categories %}
								<a class="dropdown-item" href="{% url 'category_products' category.slug %}">{{
									category.name }}</a>
								{% endfor %}
							</div>
						</li>

						<!-- Static links -->
						<li class="nav-item">
							<a class="nav-link" href="{% url 'about' %}">About Us</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="{% url 'contact' %}">Contact</a>
						</li>

						<!-- Login/Register link -->
						{% if not user.is_authenticated %}
						<li class="nav-item">
							<a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight"
								aria-controls="offcanvasRight">Login/Register</a>
						</li>
						{% else %}
						<li class="nav-item">
							<form method="POST" action="{% url 'logout' %}">
								{% csrf_token %}
								<button type="submit" class="btn btn-link nav-link"
									style="border: none; background: none;">
									Logout
								</button>
							</form>
						</li>
						{% endif %}
					</ul>
				</div>
			</div>
		</nav>

		<!-- Offcanvas for Login/Register -->
		<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
			<div class="offcanvas-header">
				<h5 id="offcanvasRightLabel">REGISTER</h5>
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<!-- Registration Form (initially shown) -->
				<div id="register-form">
					<form method="POST" action="{% url 'register' %}">
						{% csrf_token %}
						<div class="mb-3">
							<label for="username" class="form-label">Username</label>
							<input type="text" class="form-control" id="username" name="username" required>
						</div>
						<div class="mb-3">
							<label for="email" class="form-label">Email</label>
							<input type="email" class="form-control" id="email" name="email" required>
						</div>
						<div class="mb-3">
							<label for="password" class="form-label">Password</label>
							<input type="password" class="form-control" id="password" name="password" required>
						</div>
						<button type="submit" class="btn btn-primary">Register</button>
					</form>
					<div class="mt-3">
						<a href="#" id="show-login">Already have an account? Login here</a>
					</div>
				</div>

				<!-- Login Form (hidden initially) -->
				<div id="login-form" style="display: none;">
					<form method="POST" action="{% url 'login' %}">
						{% csrf_token %}
						<div class="mb-3">
							<label for="login-email" class="form-label">Email *</label>
							<input type="email" class="form-control" id="login-email" name="username" required>
						</div>
						<div class="mb-3">
							<label for="login-password" class="form-label">Password *</label>
							<input type="password" class="form-control" id="login-password" name="password" required>
						</div>
						<div class="mb-3">
							<a href="{% url 'password_reset' %}">Forgot your password?</a>
						</div>
						<button type="submit" class="btn btn-primary">Sign In</button>
					</form>
					<div class="mt-3">
						<a href="#" id="show-register">New customer? Create your account</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Toast Container -->
		<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
			<div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
				<div class="toast-header">
					<strong class="me-auto">Success</strong>
					<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
				</div>
				<div class="toast-body">
					Account created successfully!
				</div>
			</div>
		</div>
	</header>

	<main class="container mt-4">
		{% block content %}
		{% endblock %}
	</main>

	<footer class="footer mt-auto py-3 bg-light">
		<div class="container">
			<span class="text-muted">Â© 2024 My Shop. All rights reserved.</span>
		</div>
	</footer>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

	<!-- JavaScript to handle forms -->
	<script>
		<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const offcanvasElement = document.getElementById('offcanvasRight');
        const offcanvas = new bootstrap.Offcanvas(offcanvasElement);

        // Toggle between login and register forms
        showRegisterLink.addEventListener('click', function () {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
        });

        showLoginLink.addEventListener('click', function () {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        });

        // Function to handle form submissions
        function handleFormSubmit(form, url) {
            const submitButton = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', function (event) {
                event.preventDefault();

                const formData = new FormData(form);
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                submitButton.disabled = true; // Disable button while submitting

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest', // Mark as AJAX
                    },
                    body: formData
                })
                .then(response => response.json())  // Expect JSON response
                .then(data => {
                    if (data.success) {
                        // Show success toast
                        const successToast = new bootstrap.Toast(document.getElementById('successToast'));
                        document.querySelector('#successToast .toast-body').textContent = data.message || 'Action completed successfully!';
                        successToast.show();

                        // Close offcanvas
                        offcanvas.hide();

                        // Redirect after short delay
                        setTimeout(() => {
                            window.location.href = '/';  // Redirect to homepage
                        }, 1000);
                    } else {
                        submitButton.disabled = false;  // Re-enable submit button
                        // Show errors
                        for (let field in data.errors) {
                            let errorElement = document.createElement('div');
                            errorElement.className = 'invalid-feedback';
                            errorElement.textContent = data.errors[field][0];
                            let inputElement = form.querySelector(`[name="${field}"]`);
                            inputElement.classList.add('is-invalid');
                            inputElement.parentNode.appendChild(errorElement);
                        }
                    }
                })
                .catch(error => {
                    submitButton.disabled = false;  // Re-enable on error
                    console.error('Error:', error);
                });
            });
        }

        // Handle registration and login form submissions
        handleFormSubmit(document.querySelector('#register-form form'), '{% url "register" %}');
        handleFormSubmit(document.querySelector('#login-form form'), '{% url "login" %}');
    });

    // Handle logout action
    document.addEventListener('DOMContentLoaded', function () {
        const logoutLink = document.querySelector('a[href="{% url 'logout' %}"]');
        if (logoutLink) {
            logoutLink.addEventListener('click', function (e) {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    window.location.href = this.href;
                }
            });
        }
    });
</script>

	</script>
</body>

</html>