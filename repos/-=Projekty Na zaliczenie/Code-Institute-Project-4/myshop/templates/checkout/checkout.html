{% extends 'base.html' %}
{% csrf_token %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="checkout-container container mt-5">
	<div class="row">
		<!-- Left side: Contact, Delivery, and Payment form -->
		<div class="col-md-7">
			<h2>Contact Information</h2>
			<form method="POST" id="checkout-form">
				{% csrf_token %}

				<!-- Contact Section -->
				<div class="mb-3">
					<label for="email" class="form-label">Email</label>
					<input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
				</div>

				<!-- Delivery Section -->
				<h3>Delivery</h3>
				<div class="mb-3">
					<label for="country" class="form-label">Country/Region</label>
					<select class="form-select" id="country" name="country" required>
						<option value="GB">United Kingdom</option>
						<option value="PL">Poland</option>
					</select>

				</div>

				<div class="row">
					<div class="col-md-6 mb-3">
						<label for="first_name" class="form-label">First Name</label>
						<input type="text" class="form-control" id="first_name" name="first_name" required>
					</div>
					<div class="col-md-6 mb-3">
						<label for="last_name" class="form-label">Last Name</label>
						<input type="text" class="form-control" id="last_name" name="last_name" required>
					</div>
				</div>

				<div class="mb-3">
					<label for="address" class="form-label">Address</label>
					<input type="text" class="form-control" id="address" name="address" placeholder="Street Address"
						required>
				</div>

				<div class="mb-3">
					<label for="city" class="form-label">City</label>
					<input type="text" class="form-control" id="city" name="city" required>
				</div>

				<div class="row">
					<div class="col-md-6 mb-3">
						<label for="postcode" class="form-label">Postcode</label>
						<input type="text" class="form-control" id="postcode" name="postcode" required>
					</div>
					<div class="col-md-6 mb-3">
						<label for="phone" class="form-label">Phone</label>
						<input type="tel" class="form-control" id="phone" name="phone" placeholder="Phone Number"
							required>
					</div>
				</div>

				<!-- Payment Section -->
				<h3>Payment</h3>
				<div class="form-check mb-3">
					<input class="form-check-input" name="payment_method" id="credit_card" value="credit_card" checked>
					<label class="form-check-label" for="credit_card">Credit Card</label>
				</div>

				<!-- Stripe payment form -->
				<div id="card-element" class="mb-3">
					<!-- Stripe will inject the Card element here -->
				</div>
				<button type="submit" class="btn btn-primary">Pay Now</button>

				<!-- Error Display -->
				<div id="card-errors" role="alert" class="text-danger mt-2"></div>
			</form>
		</div>

		<!-- Right side: Order Summary -->
		<div class="col-md-5">
			<h2>Order Summary</h2>
			<div class="order-summary">
				<ul class="list-group mb-3">
					{% for item in cart_items %}
					<li class="list-group-item d-flex justify-content-between lh-condensed">
						<div class="order-item-img">
							<img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-thumbnail"
								style="width: 75px; height: 75px;">
						</div>
						<div class="order-item-details ms-3">
							<h6 class="my-0">{{ item.product.name }}</h6>
							<small class="text-muted">Quantity: {{ item.quantity }}</small>
						</div>
						<span class="text-muted">£{{ item.get_total_price }}</span>
					</li>
					{% endfor %}
				</ul>
				<ul class="list-group mb-3">
					<li class="list-group-item d-flex justify-content-between">
						<span>Subtotal</span>
						<strong>£{{ total }}</strong>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<span>Shipping</span>
						<strong>Enter shipping address</strong>
					</li>
					<li class="list-group-item d-flex justify-content-between">
						<span>Total</span>
						<strong>£{{ total }}</strong>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>


{% block extra_js %}
<!-- Google Maps API -->
<script>
	function loadGoogleMapsScript() {
		const script = document.createElement('script');
		script.src = https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete;
		script.async = true;
		script.defer = true;
		document.head.appendChild(script);
	}

	document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
</script>

<script>
	// Define initAutocomplete in the global scope
	function initAutocomplete() {
		const addressInput = document.getElementById('address_line1');
		if (!addressInput) return;

		const autocomplete = new google.maps.places.Autocomplete(addressInput, {
			types: ['address']
		});

		autocomplete.setFields(['address_component']);
		autocomplete.addListener('place_changed', function () {
			const place = autocomplete.getPlace();
			if (!place.address_components) return;

			// Clear previous values
			document.getElementById('city').value = '';
			document.getElementById('state').value = '';
			document.getElementById('postcode').value = '';
			document.getElementById('country').value = '';

			// Fill in fields based on selected address
			place.address_components.forEach(component => {
				const componentType = component.types[0];
				switch (componentType) {
					case 'street_number':
						const route = place.address_components.find(
							comp => comp.types[0] === 'route'
						);
						if (route) {
							addressInput.value = `${component.long_name} ${route.long_name}`;
						}
						break;
					case 'locality':
						document.getElementById('city').value = component.long_name;
						break;
					case 'administrative_area_level_1':
						document.getElementById('state').value = component.long_name;
						break;
					case 'postal_code':
						document.getElementById('postcode').value = component.long_name;
						break;
					case 'country':
						const countrySelect = document.getElementById('country');
						if (countrySelect) {
							countrySelect.value = component.short_name;
						}
						break;
				}
			});
		});
	}

	// Load Google Maps script
	function loadGoogleMapsScript() {
		const script = document.createElement('script');
		script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete`;
		script.async = true;
		script.defer = true;
		document.head.appendChild(script);
	}

	// Call function to load the Google Maps script
	document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
</script>

<script>
	const response = await fetch("{% url 'checkout:checkout' %}", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': '{{ csrf_token }}',
		},
		body: JSON.stringify({
			payment_method_id: result.paymentMethod.id,
			order_data: {
				first_name: form.first_name.value,
				last_name: form.last_name.value,
				email: form.email.value,
				phone: form.phone.value,
				address: form.address.value,
				city: form.city.value,
				postcode: form.postcode.value,
				country: form.country.value
			}
		})
	});

</script>



<!-- Stripe Integration -->
<script src="https://js.stripe.com/v3/"></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		const stripe = Stripe('{{ stripe_pub_key }}');
		const elements = stripe.elements();
		const cardElement = elements.create('card', {
			style: {
				base: {
					fontSize: '16px',
					color: '#32325d',
					'::placeholder': { color: '#aab7c4' }
				},
				invalid: { color: '#fa755a', iconColor: '#fa755a' }
			}
		});

		cardElement.mount('#card-element');

		// Retrieve CSRF token from the form
		const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

		const form = document.getElementById('checkout-form');
		const cardErrors = document.getElementById('card-errors');

		form.addEventListener('submit', async function (event) {
			event.preventDefault();
			const submitButton = form.querySelector('button[type="submit"]');
			submitButton.disabled = true;

			try {
				// Create the Stripe payment method
				const result = await stripe.createPaymentMethod({
					type: 'card',
					card: cardElement,
					billing_details: {
						name: `${form.first_name.value} ${form.last_name.value}`,
						email: form.email.value,
						phone: form.phone.value,
						address: {
							line1: form.address.value,
							city: form.city.value,
							postal_code: form.postcode.value,
							country: form.country.value
						}
					}
				});

				if (result.error) {
					cardErrors.textContent = result.error.message;
					submitButton.disabled = false;
					return;
				}

				// Send payment information to server
				const response = await fetch("{% url 'checkout:checkout' %}", {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': csrftoken  // Pass CSRF token in headers
					},
					body: JSON.stringify({
						payment_method_id: result.paymentMethod.id,
						order_data: {
							first_name: form.first_name.value,
							last_name: form.last_name.value,
							email: form.email.value,
							phone: form.phone.value,
							address: form.address.value,
							city: form.city.value,
							postcode: form.postcode.value,
							country: form.country.value
						}
					})
				});

				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				const session = await response.json();
				if (session.error) {
					throw new Error(session.error);
				}

				window.location.href = session.success_url;

			} catch (error) {
				cardErrors.textContent = error.message;
				submitButton.disabled = false;
			}
		});
	});
</script>


{% endblock %}

{% endblock %}